<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 7.1.0.final using JasperReports Library version 3.5.1  -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="picking_report_with_matrix" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<property name="ireport.zoom" value="2.0"/>
	<property name="ireport.x" value="480"/>
	<property name="ireport.y" value="15"/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="MACRO_DataAdapter.xml"/>
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["/home/martin/Reports/jrxml/v11/"]]></defaultValueExpression>
	</parameter>
	<parameter name="IDS" class="java.lang.Object">
		<defaultValueExpression><![CDATA[[47116]]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[WITH combo_data as (
	SELECT pt.id as "pt_id_join",
	CASE 
		WHEN pp.is_combo THEN pt_comb.id ELSE pt.id 
    END as "template_id",
    CASE 
		WHEN pp.is_combo THEN pt_comb.default_code ELSE pt.default_code 
    END as "default_code",
    CASE 
		WHEN pp.is_combo THEN pt_comb.name ELSE pt.name 
    END as "name",
    
	pc.id as "combo_id"
	
	FROM product_template pt 
	JOIN product_product pp ON pp.product_tmpl_id = pt.id
	LEFT JOIN product_combo pc ON pc.product_template_id = pt.id
	LEFT JOIN product_template pt_comb ON pc.product_template_id = pt_comb.id
)

SELECT  sp.id AS picking_id,
        sp.name AS picking_name,
        rp.name AS partner_name,
        sp.date_done::date AS picking_date,
        rpc.name AS company_name,
        rp.street AS partner_street,
        lpad(split_part(sp.name, '/', 3)::text, 8, '0') AS picking_number,
        rp.city AS partner_city,
        rcou.name AS partner_country_state,
        rp.vat AS partner_vat,
        -- dc.name AS delivery_description,
        -- sp.number_of_packages AS delivery_packages,
        sp.picking_type_id AS picking_type,
        rp.ref AS partner_ref,
        spt.code AS type,
        -- sp.carrier_tracking_ref AS picking_insured_value,
        -- dc.description AS delivery_location,
        CASE
            WHEN afp.name = 'RI'
                THEN 'Responsable Inscripto'
            ELSE
                afp.name
        END AS partner_fiscal_position,

        -- Details
        --pt.id AS template_id,
        combo_data.template_id as "template_id",
        --pt.default_code AS default_code,
        combo_data.default_code as "default_code",
        --pt.name AS template_name,
        combo_data.name as "template_name",
        it_uom.value AS unit_of_measure,
        sml.qty_done::integer AS qty_done
        
        --combo_data.tmpl as "tmpl_combo"
        
FROM stock_picking sp
JOIN stock_picking_type spt
    ON spt.id = sp.picking_type_id
LEFT JOIN res_partner rp
    ON rp.id = sp.partner_id
LEFT JOIN res_country_state rcou
    ON rcou.id = rp.state_id
-- LEFT JOIN delivery_carrier dc
--     ON dc.id = sp.carrier_id
LEFT JOIN res_partner rpc
    ON rpc.id = sp.company_id
LEFT JOIN ir_property ip
    ON split_part(ip.res_id, ',', 1)::text = 'res.partner'
        AND split_part(ip.value_reference, ',', 1)::text = 'account.fiscal.position'
        AND split_part(ip.res_id, ',', 2)::integer = rp.id
        AND ip.company_id=sp.company_id
LEFT JOIN account_fiscal_position afp
    ON split_part(ip.value_reference, ',', 1)::text = 'account.fiscal.position'
        AND split_part(ip.value_reference, ',', 2)::integer = afp.id

-- Details
JOIN stock_move sm
    ON sm.picking_id = sp.id
JOIN stock_move_line sml
    ON sml.move_id = sm.id
JOIN product_product pp
    ON pp.id = sm.product_id
JOIN product_template pt
    ON pt.id = pp.product_tmpl_id
LEFT JOIN product_uom pu
    ON sml.product_uom_id = pu.id
LEFT JOIN ir_translation it_uom
    ON SPLIT_PART(it_uom.name, ',', 1) = 'product.uom'
        AND SPLIT_PART(it_uom.name, ',', 2) = 'name'
        AND it_uom.res_id = pu.id
        AND it_uom.lang = 'es_AR'
        AND it_uom.state = 'translated'
LEFT JOIN sale_order so ON (sp.origin = so.name)
LEFT JOIN combo_data ON combo_data.pt_id_join = pt.id
WHERE $X{IN, sp.id, IDS}]]>
	</queryString>
	<field name="picking_id" class="java.lang.Integer">
		<property name="com.jaspersoft.studio.field.label" value="picking_id"/>
	</field>
	<field name="picking_name" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="picking_name"/>
	</field>
	<field name="partner_name" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="partner_name"/>
	</field>
	<field name="picking_date" class="java.sql.Date">
		<property name="com.jaspersoft.studio.field.label" value="picking_date"/>
	</field>
	<field name="company_name" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="company_name"/>
	</field>
	<field name="partner_street" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="partner_street"/>
	</field>
	<field name="picking_number" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="picking_number"/>
	</field>
	<field name="partner_city" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="partner_city"/>
	</field>
	<field name="partner_country_state" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="partner_country_state"/>
	</field>
	<field name="partner_vat" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="partner_vat"/>
	</field>
	<field name="picking_type" class="java.lang.Integer">
		<property name="com.jaspersoft.studio.field.label" value="picking_type"/>
	</field>
	<field name="partner_ref" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="partner_ref"/>
	</field>
	<field name="type" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="type"/>
	</field>
	<field name="partner_fiscal_position" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="partner_fiscal_position"/>
	</field>
	<field name="template_id" class="java.lang.Integer">
		<property name="com.jaspersoft.studio.field.label" value="template_id"/>
	</field>
	<field name="default_code" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="default_code"/>
	</field>
	<field name="template_name" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="template_name"/>
	</field>
	<field name="unit_of_measure" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.label" value="unit_of_measure"/>
	</field>
	<field name="qty_done" class="java.lang.Integer">
		<property name="com.jaspersoft.studio.field.label" value="qty_done"/>
	</field>
	<variable name="INITIAL" class="java.math.BigDecimal">
		<variableExpression><![CDATA[$V{AAA}]]></variableExpression>
		<initialValueExpression><![CDATA[new BigDecimal(0)]]></initialValueExpression>
	</variable>
	<variable name="AAA" class="java.lang.Integer">
		<variableExpression><![CDATA[$F{template_id}]]></variableExpression>
	</variable>
	<variable name="combo_origin_no_repeat" class="java.lang.Object">
		<variableExpression><![CDATA[$V{combo_origin_current}]]></variableExpression>
	</variable>
	<variable name="combo_origin_current" class="java.lang.Integer">
		<initialValueExpression><![CDATA[$F{template_id}]]></initialValueExpression>
	</variable>
	<title>
		<band height="271">
			<textField isBlankWhenNull="true">
				<reportElement x="54" y="140" width="286" height="12" isRemoveLineWhenBlank="true"/>
				<textElement lineSpacing="Single"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{partner_name}]]></textFieldExpression>
			</textField>
			<textField pattern="dd/MM/yyyy" isBlankWhenNull="true">
				<reportElement x="400" y="60" width="130" height="12" isRemoveLineWhenBlank="true"/>
				<textElement lineSpacing="Single"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{picking_date}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="54" y="160" width="286" height="12" isRemoveLineWhenBlank="true"/>
				<textElement lineSpacing="Single"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{partner_street}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="54" y="180" width="100" height="12" isRemoveLineWhenBlank="true"/>
				<textElement lineSpacing="Single"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{partner_city}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="160" y="180" width="180" height="12" isRemoveLineWhenBlank="true"/>
				<textElement lineSpacing="Single"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{partner_country_state}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="390" y="160" width="150" height="12" isRemoveLineWhenBlank="true"/>
				<textElement lineSpacing="Single"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{partner_vat}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="54" y="210" width="286" height="12"/>
				<textElement lineSpacing="Single"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{partner_fiscal_position}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="390" y="140" width="150" height="12"/>
				<textElement lineSpacing="Single"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{partner_ref}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<detail>
		<band height="15">
			<textField>
				<reportElement x="100" y="0" width="50" height="11">
					<printWhenExpression><![CDATA[$V{INITIAL}!=$V{AAA}]]></printWhenExpression>
				</reportElement>
				<textElement lineSpacing="Single">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{qty_done}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="150" y="0" width="60" height="11">
					<printWhenExpression><![CDATA[$V{INITIAL}!=$V{AAA}]]></printWhenExpression>
				</reportElement>
				<textElement lineSpacing="Single">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{unit_of_measure}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="20" y="0" width="80" height="11" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[$V{INITIAL}!=$V{AAA}]]></printWhenExpression>
				</reportElement>
				<textElement lineSpacing="Single">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{default_code}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="210" y="0" width="250" height="11">
					<printWhenExpression><![CDATA[$V{INITIAL}!=$V{AAA}]]></printWhenExpression>
				</reportElement>
				<textElement lineSpacing="Single">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{template_name}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<pageFooter>
		<band height="52">
			<textField>
				<reportElement x="35" y="36" width="99" height="14"/>
				<textElement lineSpacing="Single" markup="html">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{picking_name}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
</jasperReport>
